<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Detail</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --surface: #fff;
      --surface-alt: #f9f9f9;
      --text: #1a1a1a;
      --text-secondary: #666;
      --text-muted: #888;
      --border: #e0e0e0;
      --border-light: #ccc;
      --accent: #4a90d9;
      --accent-hover: #357abd;
      --danger: #d32f2f;
      --danger-hover: #b71c1c;
      --success-bg: #e8f5e9;
      --success-border: #a5d6a7;
      --success-text: #2e7d32;
      --shadow: rgba(0,0,0,0.1);
      --shadow-hover: rgba(0,0,0,0.15);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --surface: #1e1e1e;
        --surface-alt: #2a2a2a;
        --text: #e4e4e4;
        --text-secondary: #a0a0a0;
        --text-muted: #777;
        --border: #333;
        --border-light: #444;
        --accent: #5b9fd6;
        --accent-hover: #79b3e0;
        --danger: #ef5350;
        --danger-hover: #f44336;
        --success-bg: #1b3a1e;
        --success-border: #2e7d32;
        --success-text: #81c784;
        --shadow: rgba(0,0,0,0.3);
        --shadow-hover: rgba(0,0,0,0.5);
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .back-link { font-size: 0.9rem; margin-bottom: 1.5rem; display: inline-block; }
    .header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .header input {
      font-size: 1.4rem;
      font-weight: 700;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      flex: 1;
      min-width: 200px;
    }
    .header input:focus { outline: none; border-color: var(--accent); background: var(--surface); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .btn {
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      border: 1px solid var(--border-light);
      border-radius: 4px;
      background: var(--surface);
      cursor: pointer;
      color: var(--text-secondary);
      transition: background 0.1s;
    }
    .btn:hover { background: var(--surface-alt); }
    .btn-primary { color: #fff; background: var(--accent); border-color: var(--accent); }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-danger { color: var(--danger); border-color: var(--danger); }
    .btn-danger:hover { background: color-mix(in srgb, var(--danger) 10%, var(--surface)); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .section {
      background: var(--surface);
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .section h2 { font-size: 1.05rem; margin-bottom: 0.75rem; }
    .section label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
    .section input[type="text"], .section input[type="password"] {
      width: 100%;
      padding: 0.45rem 0.7rem;
      border: 1px solid var(--border-light);
      border-radius: 4px;
      font-size: 0.9rem;
      background: var(--surface-alt);
      color: var(--text);
      margin-bottom: 0.6rem;
    }
    .section input:focus { outline: none; border-color: var(--accent); }
    .cred-display {
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--text-secondary);
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.6rem;
      line-height: 1.6;
    }
    .cred-display .pass-hidden { color: var(--text-muted); letter-spacing: 2px; }
    .cred-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .open-badge {
      display: inline-block;
      font-size: 0.8rem;
      color: var(--success-text);
      background: var(--success-bg);
      border: 1px solid var(--success-border);
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      margin-bottom: 0.6rem;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; color: var(--text-muted); font-weight: 600; padding: 0.4rem 0.6rem; border-bottom: 2px solid var(--border); }
    td { padding: 0.5rem 0.6rem; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
    .empty { color: var(--text-muted); font-style: italic; padding: 1rem 0; }
    .analysis-panel {
      margin-top: 1rem;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text);
      white-space: pre-wrap;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 0.875rem;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 0 4px 16px var(--shadow);
    }
    .toast.show { opacity: 1; }
    .spinner-inline::after {
      content: "";
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border-light);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 0.4rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-page { text-align: center; padding: 4rem; color: var(--text-muted); }
    .regen-progress {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .doc-links {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    .doc-link {
      display: flex;
      flex-direction: column;
      padding: 0.75rem 1rem;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 6px;
      text-decoration: none;
      color: var(--text);
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .doc-link:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px var(--shadow);
      text-decoration: none;
    }
    .doc-link .doc-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.2rem; }
    .doc-link .doc-status { font-size: 0.75rem; color: var(--text-muted); }
    .doc-link .doc-status.has-content { color: var(--success-text); }
  </style>
</head>
<body>
  <a class="back-link" href="/dashboard">&larr; Back to Dashboard</a>

  <div id="page-loading" class="loading-page">Loading...</div>
  <div id="page-content" style="display:none">
    <div class="header">
      <input type="text" id="app-title" placeholder="App title">
      <div class="header-actions">
        <button class="btn btn-primary" id="save-title-btn">Save Title</button>
        <a id="open-app-link" class="btn" target="_blank">Open App &rarr;</a>
        <button class="btn btn-danger" id="delete-btn">Delete</button>
      </div>
    </div>

    <div class="section" id="creds-section">
      <h2>Credentials</h2>
      <div id="creds-content"></div>
    </div>

    <div class="section">
      <h2>Edit Requests</h2>
      <div id="edit-requests-content"></div>
      <button class="btn btn-primary" id="analyze-btn" style="margin-top:0.75rem">Analyze Customer Needs</button>
      <div id="analysis-result"></div>
    </div>

    <div class="section">
      <h2>UX Lessons Learned</h2>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.75rem">Rules extracted from edit requests — applied to all future app generation.</p>
      <div id="ux-lessons-content"></div>
    </div>

    <div class="section">
      <h2>Requirements &amp; Build Plan</h2>
      <div class="doc-links" id="doc-links"></div>
      <div style="margin-top:0.75rem">
        <button class="btn btn-danger" id="regenerate-btn">Regenerate App from PRD + ERD</button>
        <div id="regen-status" class="regen-progress"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const appId = window.location.pathname.split("/").pop();
    let appData = null;
    let passwordRevealed = false;

    async function authFetch(url, opts) {
      const res = await fetch(url, opts);
      if (res.status === 401) {
        window.location.href = "/login";
        throw new Error("Unauthorized");
      }
      return res;
    }

    async function safeJson(res) {
      const text = await res.text();
      try { return JSON.parse(text); } catch { throw new Error(text || `HTTP ${res.status}`); }
    }

    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2500);
    }

    function renderCredentials() {
      const el = document.getElementById("creds-content");
      if (appData.cred_username) {
        const passDisplay = passwordRevealed
          ? escapeHtml(appData.cred_password)
          : '<span class="pass-hidden">••••••••</span>';
        el.innerHTML = `
          <div class="cred-display">
            <strong>Username:</strong> ${escapeHtml(appData.cred_username)}<br>
            <strong>Password:</strong> ${passDisplay}
            <button class="btn" style="margin-left:0.5rem;padding:0.15rem 0.5rem;font-size:0.75rem" id="reveal-btn">${passwordRevealed ? 'Hide' : 'Show'}</button>
          </div>
          <details style="margin-bottom:0.6rem">
            <summary style="cursor:pointer;font-size:0.85rem;color:var(--text-secondary)">Edit credentials</summary>
            <div style="margin-top:0.5rem">
              <label>Username</label>
              <input type="text" id="edit-username" value="${escapeHtml(appData.cred_username)}">
              <label>Password</label>
              <input type="text" id="edit-password" value="${escapeHtml(appData.cred_password)}">
              <div class="cred-actions">
                <button class="btn btn-primary" id="save-creds-btn">Save Credentials</button>
              </div>
            </div>
          </details>
          <div class="cred-actions">
            <button class="btn" id="magic-link-btn">Copy Magic Link</button>
            <button class="btn btn-danger" id="remove-creds-btn">Remove Credentials</button>
          </div>`;
      } else {
        el.innerHTML = `
          <div class="open-badge">No credentials set &mdash; app is publicly accessible</div>
          <label>Username</label>
          <input type="text" id="edit-username" placeholder="Username">
          <label>Password</label>
          <input type="text" id="edit-password" placeholder="Password">
          <div class="cred-actions">
            <button class="btn btn-primary" id="save-creds-btn">Add Credentials</button>
          </div>`;
      }
    }

    let editRequests = [];

    function renderEditRequests(requests) {
      editRequests = requests || [];
      const el = document.getElementById("edit-requests-content");
      if (editRequests.length === 0) {
        el.innerHTML = '<div class="empty">No edit requests yet.</div>';
        document.getElementById("analyze-btn").style.display = "none";
        return;
      }
      document.getElementById("analyze-btn").style.display = "";
      el.innerHTML = `<table>
        <thead><tr><th>Time</th><th>User</th><th>Description</th><th></th></tr></thead>
        <tbody>${editRequests.map(r => `<tr>
          <td>${escapeHtml(r.created_at)}</td>
          <td>${escapeHtml(r.username)}</td>
          <td>${escapeHtml(r.description)}</td>
          <td><button class="btn btn-danger" data-action="delete-request" data-request-id="${r.id}" style="padding:0.2rem 0.5rem;font-size:0.75rem">&times;</button></td>
        </tr>`).join("")}</tbody>
      </table>`;
    }

    async function loadApp() {
      try {
        const res = await authFetch("/api/apps");
        if (!res.ok) throw new Error("Failed to load apps");
        const apps = await safeJson(res);
        appData = apps.find(a => a.id === appId);
        if (!appData) {
          document.getElementById("page-loading").textContent = "App not found.";
          return;
        }

        document.title = appData.title + " — Detail";
        document.getElementById("app-title").value = appData.title;
        document.getElementById("open-app-link").href = "/apps/" + appId;
        renderCredentials();
        loadDocLinks();

        const reqRes = await authFetch(`/api/apps/${appId}/edit-requests`);
        const requests = reqRes.ok ? await safeJson(reqRes) : [];
        renderEditRequests(requests);

        document.getElementById("page-loading").style.display = "none";
        document.getElementById("page-content").style.display = "";
      } catch (e) {
        document.getElementById("page-loading").textContent = "Error: " + e.message;
      }
    }

    // Save title
    document.getElementById("save-title-btn").addEventListener("click", async () => {
      const title = document.getElementById("app-title").value.trim();
      if (!title) { showToast("Title is required"); return; }
      try {
        const res = await authFetch(`/api/apps/${appId}/title`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title }),
        });
        if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
        appData.title = title;
        document.title = title + " — Detail";
        showToast("Title saved");
      } catch (e) { showToast("Error: " + e.message); }
    });

    // Delete app
    document.getElementById("delete-btn").addEventListener("click", async () => {
      if (!confirm(`Delete "${appData.title}"? This will permanently remove the app and all its data.`)) return;
      try {
        const res = await authFetch(`/api/apps/${appId}/delete`, { method: "POST" });
        if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
        window.location.href = "/dashboard";
      } catch (e) { showToast("Error: " + e.message); }
    });

    // Analyze requests
    document.getElementById("analyze-btn").addEventListener("click", async () => {
      const btn = document.getElementById("analyze-btn");
      const result = document.getElementById("analysis-result");
      btn.disabled = true;
      btn.innerHTML = 'Analyzing<span class="spinner-inline"></span>';
      result.innerHTML = "";
      try {
        const res = await authFetch(`/api/apps/${appId}/edit-requests/summary`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });
        if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
        const data = await safeJson(res);
        result.innerHTML = `<div class="analysis-panel">${escapeHtml(data.summary)}</div>`;
      } catch (e) {
        result.innerHTML = `<div class="analysis-panel" style="color:var(--danger)">Error: ${escapeHtml(e.message)}</div>`;
      }
      btn.disabled = false;
      btn.textContent = "Analyze Customer Needs";
    });

    // Event delegation for dynamic credential buttons
    document.getElementById("creds-section").addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      if (btn.id === "reveal-btn") {
        passwordRevealed = !passwordRevealed;
        renderCredentials();
      }

      if (btn.id === "save-creds-btn") {
        const username = document.getElementById("edit-username").value.trim();
        const password = document.getElementById("edit-password").value.trim();
        if (!username || !password) { showToast("Both username and password are required"); return; }
        try {
          const res = await authFetch(`/api/apps/${appId}/credentials`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
          appData.cred_username = username;
          appData.cred_password = password;
          renderCredentials();
          showToast("Credentials saved");
        } catch (e) { showToast("Error: " + e.message); }
      }

      if (btn.id === "remove-creds-btn") {
        if (!confirm("Remove credentials? The app will become publicly accessible.")) return;
        try {
          const res = await authFetch(`/api/apps/${appId}/credentials/delete`, { method: "POST" });
          if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
          appData.cred_username = null;
          appData.cred_password = null;
          passwordRevealed = false;
          renderCredentials();
          showToast("Credentials removed");
        } catch (e) { showToast("Error: " + e.message); }
      }

      if (btn.id === "magic-link-btn") {
        try {
          const res = await authFetch(`/api/apps/${appId}/magic-link`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
          const data = await safeJson(res);
          await navigator.clipboard.writeText(data.url);
          showToast("Magic link copied!");
        } catch (e) { showToast("Error: " + e.message); }
      }
    });

    // Delete edit request
    document.getElementById("edit-requests-content").addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action='delete-request']");
      if (!btn) return;
      const requestId = btn.dataset.requestId;
      try {
        const res = await authFetch(`/api/apps/${appId}/edit-requests/${requestId}/delete`, { method: "POST" });
        if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
        renderEditRequests(editRequests.filter(r => r.id !== parseInt(requestId)));
        showToast("Request deleted");
      } catch (e) { showToast("Error: " + e.message); }
    });

    // === UX Lessons ===
    let uxLessons = [];

    function renderUxLessons() {
      const el = document.getElementById("ux-lessons-content");
      if (uxLessons.length === 0) {
        el.innerHTML = '<div class="empty">No lessons learned yet. Lessons are extracted automatically when edits are made.</div>';
        return;
      }
      el.innerHTML = `<table>
        <thead><tr><th>Rule</th><th>Source</th><th></th></tr></thead>
        <tbody>${uxLessons.map(l => `<tr>
          <td>${escapeHtml(l.lesson)}</td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escapeHtml(l.source_edit_description || '')}">${escapeHtml(l.source_edit_description || '—')}</td>
          <td><button class="btn btn-danger" data-action="delete-lesson" data-lesson-id="${l.id}" style="padding:0.2rem 0.5rem;font-size:0.75rem">&times;</button></td>
        </tr>`).join("")}</tbody>
      </table>`;
    }

    async function loadUxLessons() {
      try {
        const res = await authFetch("/api/ux-lessons");
        if (res.ok) {
          uxLessons = await safeJson(res);
          renderUxLessons();
        }
      } catch { /* ignore */ }
    }

    document.getElementById("ux-lessons-content").addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action='delete-lesson']");
      if (!btn) return;
      const lessonId = btn.dataset.lessonId;
      try {
        const res = await authFetch(`/api/ux-lessons/${lessonId}/delete`, { method: "POST" });
        if (!res.ok) { const d = await safeJson(res); throw new Error(d.error); }
        uxLessons = uxLessons.filter(l => l.id !== parseInt(lessonId));
        renderUxLessons();
        showToast("Lesson deleted");
      } catch (e) { showToast("Error: " + e.message); }
    });

    // === Requirements & Build Plan links ===

    function loadDocLinks() {
      if (!appData) return;
      const el = document.getElementById("doc-links");
      const prdStatus = appData.prd ? "has-content" : "";
      const erdStatus = appData.erd ? "has-content" : "";
      const pocStatus = appData.poc_plan ? "has-content" : "";
      el.innerHTML = `
        <a class="doc-link" href="/dashboard/apps/${appId}/prd">
          <span class="doc-title">PRD</span>
          <span class="doc-status ${prdStatus}">${appData.prd ? "Saved" : "Not generated"}</span>
        </a>
        <a class="doc-link" href="/dashboard/apps/${appId}/erd">
          <span class="doc-title">ERD</span>
          <span class="doc-status ${erdStatus}">${appData.erd ? "Saved" : "Not generated"}</span>
        </a>
        <a class="doc-link" href="/dashboard/apps/${appId}/poc-plan">
          <span class="doc-title">POC Build Plan</span>
          <span class="doc-status ${pocStatus}">${appData.poc_plan ? "Saved" : "Not generated"}</span>
        </a>`;
    }

    // Regenerate
    document.getElementById("regenerate-btn").addEventListener("click", async () => {
      if (!appData.prd || !appData.erd) {
        showToast("Both PRD and ERD are required. Open them from the links above to generate.");
        return;
      }
      if (!confirm("This will rebuild the entire app from the PRD and ERD, replacing current HTML and data. Continue?")) return;

      const btn = document.getElementById("regenerate-btn");
      const statusEl = document.getElementById("regen-status");
      btn.disabled = true;
      statusEl.textContent = "Starting regeneration...";
      statusEl.style.color = "";

      try {
        const res = await authFetch(`/api/apps/${appId}/regenerate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });

        if (!res.ok) {
          const text = await res.text();
          let errMsg = "Regeneration failed";
          try { errMsg = JSON.parse(text).error || errMsg; } catch {}
          throw new Error(errMsg);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buf = "";
        let done = false;

        while (!done) {
          const result = await reader.read();
          if (result.done) { done = true; break; }
          buf += decoder.decode(result.value, { stream: true });
          const lines = buf.split("\n");
          buf = lines.pop() || "";
          let evtType = "";
          for (const line of lines) {
            if (line.startsWith("event: ")) { evtType = line.slice(7).trim(); }
            else if (line.startsWith("data: ")) {
              try {
                const ev = JSON.parse(line.slice(6));
                if (evtType === "error" || ev.step === "error") {
                  throw new Error(ev.message || "Regeneration failed");
                }
                if (ev.step === "complete") {
                  statusEl.textContent = "Regeneration complete! Refresh the app to see changes.";
                  statusEl.style.color = "var(--success-text)";
                  btn.disabled = false;
                  return;
                }
                statusEl.textContent = ev.message || "Working...";
              } catch (pe) {
                if (pe.message && pe.message !== "Regeneration failed") throw pe;
              }
            }
          }
        }
        statusEl.textContent = "Regeneration complete!";
        btn.disabled = false;
      } catch (e) {
        statusEl.textContent = "Error: " + e.message;
        statusEl.style.color = "var(--danger)";
        btn.disabled = false;
      }
    });

    loadApp();
    loadUxLessons();
  </script>
</body>
</html>
