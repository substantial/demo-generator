<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{TITLE}}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
#__app_frame{width:100%;height:100%;border:none}

#__chat_toggle{position:fixed;bottom:20px;right:20px;z-index:9999;width:52px;height:52px;border-radius:50%;background:#4a90d9;color:#fff;border:none;font-size:1.4rem;cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;transition:transform .15s}
#__chat_toggle:hover{transform:scale(1.08)}
#__chat_badge{position:absolute;top:-4px;right:-4px;min-width:20px;height:20px;border-radius:10px;background:#e53935;color:#fff;font-size:.7rem;font-weight:700;display:none;align-items:center;justify-content:center;padding:0 5px;line-height:1}
#__chat_badge.show{display:flex}

#__chat_panel{display:none;position:fixed;bottom:80px;right:20px;z-index:10000;width:400px;max-width:calc(100vw - 40px);height:520px;max-height:calc(100vh - 100px);background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.25);flex-direction:column;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;overflow:hidden}
#__chat_panel.open{display:flex}

#__chat_header{padding:12px 16px;background:#4a90d9;color:#fff;font-weight:600;font-size:.95rem;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
#__chat_header button{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;padding:0 4px;opacity:.8}
#__chat_header button:hover{opacity:1}

#__chat_messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px}

.__chat_msg{max-width:85%;padding:8px 12px;border-radius:12px;font-size:.875rem;line-height:1.4;word-wrap:break-word}
.__chat_msg.user{align-self:flex-end;background:#4a90d9;color:#fff;border-bottom-right-radius:4px}
.__chat_msg.assistant{align-self:flex-start;background:#f0f0f0;color:#333;border-bottom-left-radius:4px}
.__chat_msg.system{align-self:center;background:none;color:#888;font-size:.8rem;font-style:italic;padding:4px 0}
.__chat_msg.error{align-self:center;background:#fee;color:#d32f2f;font-size:.8rem;padding:6px 10px;border-radius:6px}

#__chat_typing{display:none;align-self:flex-start;padding:8px 12px;background:#f0f0f0;border-radius:12px;border-bottom-left-radius:4px;font-size:.875rem;color:#888}
#__chat_typing.active{display:block}
#__chat_typing span{display:inline-block;animation:__dots 1.4s infinite}
#__chat_typing span:nth-child(2){animation-delay:.2s}
#__chat_typing span:nth-child(3){animation-delay:.4s}
@keyframes __dots{0%,80%,100%{opacity:.3}40%{opacity:1}}

#__chat_input_area{display:flex;gap:8px;padding:12px;border-top:1px solid #e0e0e0;flex-shrink:0}
#__chat_input{flex:1;padding:8px 12px;border:1px solid #ccc;border-radius:20px;font-size:.875rem;outline:none;resize:none;max-height:80px;font-family:inherit;line-height:1.4}
#__chat_input:focus{border-color:#4a90d9}
#__chat_send{width:36px;height:36px;border-radius:50%;background:#4a90d9;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end}
#__chat_send:hover{background:#357abd}

#__chat_status{display:none;padding:6px 16px;font-size:.75rem;color:#666;background:#f9f9f9;border-top:1px solid #e0e0e0;flex-shrink:0;text-align:center}
#__chat_status.show{display:block}

@media(prefers-color-scheme:dark){
  #__chat_panel{background:#1e1e1e;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .__chat_msg.assistant{background:#2a2a2a;color:#e4e4e4}
  .__chat_msg.system{color:#777}
  .__chat_msg.error{background:#3a1a1a;color:#ef5350}
  #__chat_input{background:#2a2a2a;color:#e4e4e4;border-color:#444}
  #__chat_input:focus{border-color:#5b9fd6}
  #__chat_input_area{border-top-color:#333}
  #__chat_status{background:#2a2a2a;border-top-color:#333;color:#a0a0a0}
  #__chat_typing{background:#2a2a2a;color:#777}
}
</style>
</head>
<body>

<iframe id="__app_frame" src="/apps/{{APP_ID}}?embed=1"></iframe>

<div id="__chat_panel">
  <div id="__chat_header">
    <span>{{HEADER_TEXT}}</span>
    <button onclick="document.getElementById('__chat_panel').classList.remove('open')" title="Close">&times;</button>
  </div>
  <div id="__chat_messages">
    <div class="__chat_msg system">{{SYSTEM_MSG}}</div>
  </div>
  <div id="__chat_status"></div>
  <div id="__chat_input_area">
    <textarea id="__chat_input" rows="1" placeholder="{{PLACEHOLDER}}"></textarea>
    <button id="__chat_send" title="Send">&#9654;</button>
  </div>
</div>

<button id="__chat_toggle" title="{{HEADER_TEXT}}">&#9998;<span id="__chat_badge"></span></button>

<script>
(function(){
  var panel = document.getElementById('__chat_panel');
  var toggle = document.getElementById('__chat_toggle');
  var badge = document.getElementById('__chat_badge');
  var messages = document.getElementById('__chat_messages');
  var input = document.getElementById('__chat_input');
  var sendBtn = document.getElementById('__chat_send');
  var statusBar = document.getElementById('__chat_status');
  var frame = document.getElementById('__app_frame');
  var appId = '{{APP_ID}}';

  var queue = [];
  var processing = false;
  var editCount = 0;

  toggle.addEventListener('click', function(){
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) input.focus();
  });

  function addMsg(text, cls) {
    var d = document.createElement('div');
    d.className = '__chat_msg ' + cls;
    d.textContent = text;
    messages.appendChild(d);
    messages.scrollTop = messages.scrollHeight;
    return d;
  }

  function updateBadge() {
    var count = queue.length + (processing ? 1 : 0);
    if (count > 0) {
      badge.textContent = count;
      badge.classList.add('show');
    } else {
      badge.classList.remove('show');
    }
  }

  function setStatus(text) {
    if (text) {
      statusBar.textContent = text;
      statusBar.classList.add('show');
    } else {
      statusBar.classList.remove('show');
    }
  }

  function showTyping(text) {
    var t = document.getElementById('__chat_typing');
    if (!t) {
      t = document.createElement('div');
      t.id = '__chat_typing';
      messages.appendChild(t);
    }
    t.innerHTML = '<span>.</span><span>.</span><span>.</span> ' + (text || 'Applying changes');
    t.classList.add('active');
    messages.scrollTop = messages.scrollHeight;
  }

  function hideTyping() {
    var t = document.getElementById('__chat_typing');
    if (t) t.classList.remove('active');
  }

  function send() {
    var text = input.value.trim();
    if (!text) return;
    input.value = '';
    input.style.height = 'auto';
    addMsg(text, 'user');

    if (processing) {
      queue.push(text);
      updateBadge();
      setStatus('Queued: ' + queue.length + ' edit' + (queue.length > 1 ? 's' : '') + ' waiting');
      addMsg('Queued \u2014 will apply after current edit finishes', 'system');
      return;
    }

    // If there are queued items from a previous error, merge them in
    if (queue.length > 0) {
      queue.push(text);
      text = mergeQueue();
    }

    processEdit(text);
  }

  function mergeQueue() {
    var items = queue.splice(0, queue.length);
    if (items.length === 1) return items[0];
    var merged = 'Please make the following changes:\n';
    for (var i = 0; i < items.length; i++) {
      merged += '\n' + (i + 1) + '. ' + items[i];
    }
    return merged;
  }

  function processEdit(description) {
    processing = true;
    editCount++;
    var currentEdit = editCount;
    updateBadge();
    var queueNote = queue.length > 0 ? ' (' + queue.length + ' more queued)' : '';
    showTyping('Applying edit #' + currentEdit + queueNote);
    setStatus('Processing edit #' + currentEdit + '...' + queueNote);

    fetch('/api/apps/' + appId + '/edit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description: description })
    }).then(function(res) {
      if (!res.ok) {
        return res.text().then(function(errText) {
          var errMsg = 'Edit failed';
          try { errMsg = JSON.parse(errText).error || errMsg; } catch(e2) {}
          throw new Error(errMsg);
        });
      }
      var reader = res.body.getReader();
      var decoder = new TextDecoder();
      var buf = '';

      function pump() {
        return reader.read().then(function(result) {
          if (result.done) {
            onEditComplete(currentEdit);
            return;
          }
          buf += decoder.decode(result.value, { stream: true });
          var lines = buf.split('\n');
          buf = lines.pop() || '';
          var evtType = '';
          for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if (line.indexOf('event: ') === 0) {
              evtType = line.slice(7).trim();
            } else if (line.indexOf('data: ') === 0) {
              try {
                var ev = JSON.parse(line.slice(6));
                if (evtType === 'error' || ev.step === 'error') {
                  hideTyping();
                  addMsg('Error: ' + ev.message, 'error');
                  onEditError();
                  return;
                }
                if (ev.step === 'complete') {
                  onEditComplete(currentEdit);
                  return;
                }
                var label = ev.message || 'Working...';
                if (ev.tokens) label = ev.message + ' (' + ev.tokens + ' tokens)';
                var qn = queue.length > 0 ? ' [' + queue.length + ' queued]' : '';
                showTyping(label + qn);
              } catch(pe) {}
            }
          }
          return pump();
        });
      }

      return pump();
    }).catch(function(e) {
      hideTyping();
      addMsg('Error: ' + e.message, 'error');
      onEditError();
    });
  }

  function onEditComplete(editNum) {
    hideTyping();
    addMsg('Edit #' + editNum + ' applied \u2713', 'assistant');

    if (queue.length > 0) {
      var next = mergeQueue();
      updateBadge();
      setStatus('Processing next edit...');
      processEdit(next);
      return;
    }

    // All done - refresh the iframe to show changes
    processing = false;
    updateBadge();
    setStatus('');
    frame.contentWindow.location.reload();
    addMsg('All changes applied! App refreshed.', 'assistant');
  }

  function onEditError() {
    processing = false;
    updateBadge();
    if (queue.length > 0) {
      setStatus(queue.length + ' edit' + (queue.length > 1 ? 's' : '') + ' queued \u2014 send a message to continue');
    } else {
      setStatus('');
    }
  }

  sendBtn.addEventListener('click', send);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });
  input.addEventListener('input', function() {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 80) + 'px';
  });
})();
</script>
</body>
</html>
